AWSTemplateFormatVersion: '2010-09-09'
Transform:
  - AWS::LanguageExtensions
  - AWS::Serverless-2016-10-31
Parameters:
  StackTemplatesS3BucketName:
    Type: String
    Description: The name of the S3 bucket where the stack templates are stored
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID for ECS tasks
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnet IDs for ECS tasks (comma-separated)
  SecurityGroupIds:
    Type: List<AWS::EC2::SecurityGroup::Id>
    Description: Security Group IDs for ECS tasks (comma-separated)
Resources:
  AWSTestHarnessTesterRole:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        StateMachineArn: !GetAtt ExampleStateMachine.Outputs.StateMachineArn
      TemplateURL: !Sub https://${StackTemplatesS3BucketName}.s3.${AWS::Region}.amazonaws.com/aws-test-harness-templates/tester-role.yaml
  AWSTestHarnessTestDoubles:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        DynamoDBTables:
          Fn::ToJsonString:
            First:
              PartitionKey:
                Name: PK
                Type: S
              SortKey:
                Name: SK
                Type: S
            Second:
              PartitionKey:
                Name: ID
                Type: S
        LambdaFunctionNames: First, Second
        StateMachineNames: First, Second
        S3BucketNames: First, Second
        ECSTaskDefinitions:
          Fn::ToJsonString:
            First:
              Containers:
                - Blue
                - Yellow
            Second:
              Containers:
                - Orange
                - Green
      TemplateURL: !Sub https://${StackTemplatesS3BucketName}.s3.${AWS::Region}.amazonaws.com/aws-test-harness-templates/test-doubles.yaml
  ExampleStateMachine:
    Type: AWS::Serverless::Application
    Properties:
      Location: ../../example-state-machine/template.yaml
      Parameters:
        OutOfBandDeploymentSupport: "true"
        FirstTableName: !GetAtt AWSTestHarnessTestDoubles.Outputs.FirstDynamoDBTableName
        SecondTableName: !GetAtt AWSTestHarnessTestDoubles.Outputs.SecondDynamoDBTableName
        FirstBucketName: !GetAtt AWSTestHarnessTestDoubles.Outputs.FirstS3BucketName
        SecondBucketName: !GetAtt AWSTestHarnessTestDoubles.Outputs.SecondS3BucketName
        FirstFunctionName: !GetAtt AWSTestHarnessTestDoubles.Outputs.FirstLambdaFunctionName
        FirstStateMachineArn: !GetAtt AWSTestHarnessTestDoubles.Outputs.FirstStateMachineArn
        FirstTaskDefinitionArn: !GetAtt AWSTestHarnessTestDoubles.Outputs.FirstECSTaskDefinitionArnWithoutRevision
        ECSTaskExecutionRoleArn: !GetAtt AWSTestHarnessTestDoubles.Outputs.ECSTaskExecutionRoleArn
        ECSTaskRoleArn: !GetAtt AWSTestHarnessTestDoubles.Outputs.ECSTaskRoleArn
        ECSClusterArn: !GetAtt AWSTestHarnessTestDoubles.Outputs.ECSClusterArn
        VpcId: !Ref VpcId
        SubnetIds: !Join [",", !Ref SubnetIds]
        SecurityGroupIds: !Join [",", !Ref SecurityGroupIds]